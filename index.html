<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audio Recorder + EmailJS</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .btn { padding: 10px 15px; margin: 10px 0; }
  </style>
</head>
<body>

  <h2>📚 تسجيل الطالب وإرساله</h2>

  <label>👤 الاسم:</label>
  <input type="text" id="studentName"><br><br>

  <label>📧 البريد الإلكتروني:</label>
  <input type="email" id="studentEmail"><br><br>

  <button class="btn" id="startRec">🔴 بدء التسجيل</button>
  <button class="btn" id="stopRec" disabled>⏹️ إيقاف التسجيل</button>
  <button class="btn" id="sendBtn" style="display:none;">✉️ إرسال التسجيل</button><br>

  <audio id="recordedAudio" controls style="display:none;"></audio>

  <script>
    emailjs.init("74-zUyeR-o7zE76GL"); // public key

    let mediaRecorder;
    let recordedChunks = [];
    let recordedBlob = null;

    const startBtn = document.getElementById("startRec");
    const stopBtn = document.getElementById("stopRec");
    const sendBtn = document.getElementById("sendBtn");
    const audioElement = document.getElementById("recordedAudio");

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      stopBtn.disabled = true;
      sendBtn.style.display = "inline";
      mediaRecorder.onstop = () => {
        recordedBlob = new Blob(recordedChunks, { type: "audio/webm" });
        const url = URL.createObjectURL(recordedBlob);
        audioElement.src = url;
        audioElement.style.display = "block";
      };
    };

    sendBtn.onclick = async () => {
      const name = document.getElementById("studentName").value;
      const email = document.getElementById("studentEmail").value;

      if (!name || !email || !recordedBlob) {
        alert("⚠️ الرجاء تعبئة الاسم والبريد وتسجيل الصوت أولاً.");
        return;
      }

      const base64 = await blobToBase64(recordedBlob);

      emailjs.send("service_vlapjef", "template_p0wtlnj", {
        from_name: name,
        from_email: email,
        base64_audio: base64
      }).then(() => {
        alert("✅ تم إرسال التسجيل بنجاح!");
        sendBtn.style.display = "none";
      }).catch(err => {
        alert("❌ فشل في الإرسال: " + err.text);
      });
    };

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]); // remove header
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>

</body>
</html>
