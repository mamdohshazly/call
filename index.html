<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEARN WITH SHAZLY - Student Recorder</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo&family=Scheherazade+New&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>

  <style>
    body { font-family: 'Cairo', sans-serif; padding: 20px; }
    .fade { opacity: 0; transition: opacity 0.5s ease-in-out; }
    .fade.show { opacity: 1; }
    .form-group { margin-bottom: 15px; }
    .action-btn { padding: 10px 20px; font-size: 16px; }
    #recorderBar { display: none; margin-top: 20px; }
    #successMessage {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: #fff;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 3000;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <!-- Student Info Form -->
  <section id="studentFormSection" class="fade show">
    <h2>Student Information</h2>
    <form id="studentForm">
      <div class="form-group">
        <label for="studentName">Name:</label>
        <input type="text" id="studentName" required>
      </div>

      <div class="form-group">
        <label for="studentEmail">Email:</label>
        <input type="email" id="studentEmail" required>
      </div>

      <div class="form-group">
        <label for="currentDate">Date:</label>
        <input type="text" id="currentDate" readonly>
      </div>

      <div class="form-group">
        <label for="currentTime">Time:</label>
        <input type="text" id="currentTime" readonly>
      </div>

      <button type="button" id="startButton" class="action-btn">Start Recording</button>
    </form>
  </section>

  <!-- Recording Section -->
  <section id="ayahSection" class="fade" style="display:none;">
    <h2>Recording</h2>
    <audio id="recordedAudio" controls style="display:none;"></audio>

    <div class="recorder" id="recorderBar">
      <button id="startRec">🔴 Start</button>
      <button id="stopRec" disabled>⏹️ Stop</button>
    </div>

    <div id="thanksMessage" style="display:none; text-align:center; margin-top:30px;">
      <h2>JAZAKUM ALLAH KHAIRAN</h2>
      <button id="submitBtn" class="action-btn">SUBMIT</button>
    </div>
  </section>

  <!-- Success Message -->
  <div id="successMessage">
    ✅ تم الإرسال بنجاح! تحقق من بريدك الإلكتروني.
    <button onclick="this.parentElement.style.display='none'" style="margin-left:10px;">✖</button>
  </div>

  <script>
    emailjs.init("74-zUyeR-o7zE76GL"); // ✅ public key

    document.addEventListener("DOMContentLoaded", () => {
      // إعداد التاريخ والوقت
      document.getElementById("currentDate").value = new Date().toLocaleDateString();
      document.getElementById("currentTime").value = new Date().toLocaleTimeString();

      const formSection = document.getElementById("studentFormSection");
      const ayahSection = document.getElementById("ayahSection");
      const recorderBar = document.getElementById("recorderBar");
      const recordedAudio = document.getElementById("recordedAudio");
      const thanksMessage = document.getElementById("thanksMessage");
      const successMessage = document.getElementById("successMessage");

      let mediaRecorder, recordedChunks = [];

      // الانتقال من الفورم إلى التسجيل
      document.getElementById("startButton").onclick = () => {
        formSection.style.display = "none";
        ayahSection.style.display = "block";
        recorderBar.style.display = "flex";
      };

      // بدء التسجيل
      document.getElementById("startRec").onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
        mediaRecorder.start();
        document.getElementById("startRec").disabled = true;
        document.getElementById("stopRec").disabled = false;
      };

      // إيقاف التسجيل
      document.getElementById("stopRec").onclick = () => {
        mediaRecorder.stop();
        document.getElementById("stopRec").disabled = true;

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          const url = URL.createObjectURL(blob);
          recordedAudio.src = url;
          recordedAudio.style.display = "block";
          window.recordedBlob = blob;
          thanksMessage.style.display = "block";
        };
      };

      // عند الضغط على SUBMIT
      document.getElementById("submitBtn").onclick = async () => {
        const blob = window.recordedBlob;
        const studentName = document.getElementById("studentName").value;
        const studentEmail = document.getElementById("studentEmail").value;
        const date = document.getElementById("currentDate").value;
        const time = document.getElementById("currentTime").value;

        if (!blob || !studentName || !studentEmail) {
          alert("⚠️ تأكد من إدخال البيانات وتسجيل الصوت.");
          return;
        }

        try {
          const base64 = await blobToBase64(blob);
          const link = await uploadToFileIO(base64);

          if (!link) {
            alert("❌ فشل رفع الملف!");
            return;
          }

          await emailjs.send("service_vlapjef", "template_p0wtlnj", {
            from_name: studentName,
            from_email: studentEmail,
            date: date,
            time: time,
            recording_link: link
          });

          successMessage.style.display = "block";
          setTimeout(() => {
            successMessage.style.display = "none";
          }, 4000);

        } catch (err) {
          alert("❌ حدث خطأ أثناء الإرسال: " + err.message);
        }
      };

      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      async function uploadToFileIO(base64Text) {
        const formData = new FormData();
        const blob = new Blob([base64Text], { type: 'text/plain' });
        formData.append("file", blob, "recording.txt");

        const res = await fetch("https://file.io/?expires=1d", {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        return data.success ? data.link : null;
      }
    });
  </script>
</body>
</html>
