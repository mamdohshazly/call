<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEARN WITH SHAZLY - Student Recorder</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; padding: 20px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, button, select { padding: 8px; margin-top: 5px; width: 100%; max-width: 400px; }
    button { cursor: pointer; }
    .fade { opacity: 0; transition: opacity 0.5s ease-in-out; }
    .fade.show { opacity: 1; }
    #recorderBar { display: none; margin-top: 20px; }
    #successMessage {
      display: none;
      background: #4CAF50;
      color: white;
      padding: 10px;
      margin-top: 20px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <section id="studentFormSection" class="fade show">
    <h2>Student Information</h2>
    <form id="studentForm">
      <label for="studentName">Name:</label>
      <input type="text" id="studentName" required>

      <label for="studentEmail">Email:</label>
      <input type="email" id="studentEmail" required>

      <label for="currentDate">Date:</label>
      <input type="text" id="currentDate" readonly>

      <label for="currentTime">Time:</label>
      <input type="text" id="currentTime" readonly>

      <button type="button" id="startButton">Start Your Developing</button>
    </form>
  </section>

  <section id="ayahSection" class="fade" style="display:none;">
    <h2>Select Surah and Ayah Range</h2>
    <select id="surahSelect">
      <option value="">Select Surah</option>
    </select>
    <label for="fromAyah">From Ayah:</label>
    <input type="number" id="fromAyah" min="1">

    <label for="toAyah">To Ayah:</label>
    <input type="number" id="toAyah" min="1">

    <button id="loadAyahs">üéß Load Ayahs</button>
    <div id="ayahs"></div>

    <audio id="mainPlayer" controls></audio>
    <audio id="recordedAudio" controls style="display:none; margin-top:15px;"></audio>

    <div id="recorderBar">
      <button id="startRec">üî¥ Start</button>
      <button id="pauseRec" disabled>‚è∏Ô∏è Pause</button>
      <button id="stopRec" disabled>‚èπÔ∏è Stop</button>
    </div>

    <div id="thanksMessage" style="display:none; text-align:center; margin-top:30px;">
      <h2>JAZAKUM ALLAH KHAIRAN</h2>
      <button id="submitBtn">SUBMIT</button>
    </div>
  </section>

  <div id="successMessage"></div>

  <script>
    emailjs.init("UPiVfipXxhGdU_CQA06Sh");

    const surahNames = ["","Al-Fatiha","Al-Baqara","Aali Imran","An-Nisa","Al-Ma'ida","Al-An'am","Al-A'raf","Al-Anfal","At-Tawba","Yunus","Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra","Al-Kahf","Maryam","Ta-Ha","Al-Anbiya","Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Ash-Shu'ara","An-Naml","Al-Qasas","Al-Ankabut","Ar-Rum","Luqman","As-Sajda","Al-Ahzab","Saba","Fatir","Ya-Sin","As-Saffat","Sad","Az-Zumar","Ghafir","Fussilat","Ash-Shura","Az-Zukhruf","Ad-Dukhan","Al-Jathiya","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf","Adh-Dhariyat","At-Tur","An-Najm","Al-Qamar","Ar-Rahman","Al-Waqia","Al-Hadid","Al-Mujadila","Al-Hashr","Al-Mumtahina","As-Saff","Al-Jumua","Al-Munafiqun","At-Taghabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqa","Al-Ma'arij","Nuh","Al-Jinn","Al-Muzzammil","Al-Muddathir","Al-Qiyama","Al-Insan","Al-Mursalat","An-Naba","An-Nazi'at","Abasa","At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Inshiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Ghashiya","Al-Fajr","Al-Balad","Ash-Shams","Al-Lail","Ad-Duha","Ash-Sharh","At-Tin","Al-'Alaq","Al-Qadr","Al-Bayyina","Az-Zalzala","Al-Adiyat","Al-Qari'a","At-Takathur","Al-Asr","Al-Humaza","Al-Fil","Quraish","Al-Ma'un","Al-Kawthar","Al-Kafirun","An-Nasr","Al-Masad","Al-Ikhlas","Al-Falaq","An-Nas"];

    const surahSelect = document.getElementById("surahSelect");
    surahNames.forEach((name, index) => {
      if (index === 0) return;
      const opt = document.createElement("option");
      opt.value = index;
      opt.textContent = `${index}. ${name}`;
      surahSelect.appendChild(opt);
    });

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("currentDate").value = new Date().toLocaleDateString();
      document.getElementById("currentTime").value = new Date().toLocaleTimeString();

      const startButton = document.getElementById("startButton");
      const recorderBar = document.getElementById("recorderBar");
      const formSection = document.getElementById("studentFormSection");
      const ayahSection = document.getElementById("ayahSection");
      const recordedAudio = document.getElementById("recordedAudio");
      const thanksMessage = document.getElementById("thanksMessage");
      const successMessage = document.getElementById("successMessage");

      let mediaRecorder, recordedChunks = [];

      startButton.addEventListener("click", () => {
        formSection.classList.remove("show");
        setTimeout(() => {
          formSection.style.display = "none";
          ayahSection.style.display = "block";
          requestAnimationFrame(() => {
            ayahSection.classList.add("show");
            recorderBar.style.display = "block";
          });
        }, 500);
      });

      document.getElementById("startRec").onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
        mediaRecorder.start();
        document.getElementById("startRec").disabled = true;
        document.getElementById("pauseRec").disabled = false;
        document.getElementById("stopRec").disabled = false;
      };

      document.getElementById("pauseRec").onclick = () => {
        if (mediaRecorder.state === "recording") mediaRecorder.pause();
        else if (mediaRecorder.state === "paused") mediaRecorder.resume();
      };

      document.getElementById("stopRec").onclick = () => {
        mediaRecorder.stop();
        document.getElementById("stopRec").disabled = true;
        document.getElementById("pauseRec").disabled = true;
        document.getElementById("startRec").disabled = false;
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          const url = URL.createObjectURL(blob);
          recordedAudio.src = url;
          recordedAudio.style.display = "block";
          window.recordedBlob = blob;
          thanksMessage.style.display = "block";
        };
      };

      document.getElementById("submitBtn").onclick = async () => {
        const blob = window.recordedBlob;
        const studentName = document.getElementById("studentName").value;
        const studentEmail = document.getElementById("studentEmail").value;
        const date = document.getElementById("currentDate").value;
        const time = document.getElementById("currentTime").value;

        if (!blob || !studentName || !studentEmail) {
          alert("‚ö†Ô∏è ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿµŸàÿ™.");
          return;
        }

        try {
          const key = crypto.getRandomValues(new Uint8Array(32));
          const iv = crypto.getRandomValues(new Uint8Array(12));
          const alg = { name: "AES-GCM", iv };
          const cryptoKey = await crypto.subtle.importKey("raw", key, alg, false, ["encrypt"]);
          const encrypted = await crypto.subtle.encrypt(alg, cryptoKey, await blob.arrayBuffer());

          const combined = new Uint8Array(iv.length + encrypted.byteLength);
          combined.set(iv);
          combined.set(new Uint8Array(encrypted), iv.length);
          const base64Encoded = btoa(String.fromCharCode(...combined));

          const fileName = `recording-${Date.now()}.txt`;
          const githubApiUrl = `https://api.github.com/repos/mamdohshazly/call/contents/recordings/${fileName}`;
          const githubToken = "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";

          const githubUpload = await fetch(githubApiUrl, {
            method: "PUT",
            headers: {
              "Authorization": `Bearer ${githubToken}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: `Upload from ${studentName}`,
              content: btoa(base64Encoded)
            })
          });

          if (!githubUpload.ok) {
            alert("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ GitHub");
            return;
          }

          await emailjs.send("service_vlapjef", "template_jhbppzj", {
            student_name: studentName,
            student_email: studentEmail,
            date,
            time,
            message: `üì• ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ¨ÿØŸäÿØ ŸÖŸÜ ÿßŸÑÿ∑ÿßŸÑÿ®: ${studentName}`
          });

          successMessage.textContent = "‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±ÿå ŸàÿßŸÑÿ±ŸÅÿπÿå ŸàÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!";
          successMessage.style.display = "block";
          setTimeout(() => {
            successMessage.style.display = "none";
          }, 4000);

        } catch (err) {
          alert("‚ùå ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©: " + err.message);
        }
      };
    });
  </script>
</body>
</html>
